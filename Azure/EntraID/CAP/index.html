<!DOCTYPE html>
<html lang="en" data-theme="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dynamic Conditional Access Policies with Custom Security Attributes: Enterprise Architecture Guide</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@picocss/pico@1/css/pico.min.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
      :root {
        --primary-blue: #0078d4;
        --dark-blue: #004578;
        --accent-green: #107c10;
        --warning-orange: #ff8c00;
        --error-red: #d13438;
        --bg-gray: #f5f5f5;
        --text-dark: #323130;
        --border-gray: #edebe9;
      }
      body {
        font-family: 'Inter', sans-serif;
        font-size: 11pt;
        line-height: 1.6;
        color: var(--text-dark);
        background: white;
        max-width: 880px;
        margin: 0 auto;
        padding: 0 80px 32px 80px;
        box-sizing: border-box;
      }
      /* Back to home bar */
      .back-bar {
        background-color: #0a1628;
        padding: 12px 20px;
        margin: 0 -80px 32px -80px;
        display: flex;
        align-items: center;
        justify-content: space-between;
      }
      .back-bar a {
        color: #56a0fa;
        text-decoration: none;
        font-size: 0.9rem;
        font-weight: 500;
        display: flex;
        align-items: center;
        gap: 0.4rem;
        transition: color 0.2s;
      }
      .back-bar a:hover { color: #ffffff; }
      .back-bar .breadcrumb {
        font-size: 0.78rem;
        color: #8a9bbf;
      }
      .back-bar .breadcrumb span { color: #56a0fa; }
      .author-line {
        text-align: center;
        font-size: 10pt;
        color: #777;
        margin-bottom: 30px;
      }
      .author-line a { color: #004578; text-decoration: none; font-weight: 600; }
      .author-line a:hover { text-decoration: underline; }
      h1 { font-size: 28pt; font-weight: 600; color: var(--primary-blue); margin: 40px 0 20px 0; text-align: center; }
      h2 { font-size: 22pt; font-weight: 600; color: var(--dark-blue); margin: 30px 0 15px 0; border-bottom: 2px solid var(--primary-blue); padding-bottom: 5px; }
      h3 { font-size: 18pt; font-weight: 500; color: var(--dark-blue); margin: 25px 0 12px 0; }
      h4 { font-size: 16pt; font-weight: 500; color: var(--text-dark); margin: 20px 0 10px 0; }
      p { margin: 10px 0; text-align: justify; }
      .title-page { text-align: center; padding: 60px 0 40px 0; margin-bottom: 30px; border-bottom: 3px solid var(--primary-blue); }
      .title-page h1 { font-size: 32pt; margin: 20px 0; line-height: 1.2; }
      .title-page .subtitle { font-size: 16pt; color: var(--dark-blue); margin: 15px 0; font-weight: 500; }
      .title-page .metadata { font-size: 11pt; margin: 30px 0 10px 0; color: var(--text-dark); }
      .callout { padding: 20px; margin: 20px 0; border-radius: 8px; border-left: 5px solid; }
      .callout-info { background: #e3f2fd; border-left-color: var(--primary-blue); }
      .callout-warning { background: #fff3e0; border-left-color: var(--warning-orange); }
      .callout-success { background: #e8f5e9; border-left-color: var(--accent-green); }
      .callout-critical { background: #ffebee; border-left-color: var(--error-red); }
      .callout-title { font-weight: 600; font-size: 12pt; margin-bottom: 10px; }
      table { width: 100%; border-collapse: collapse; margin: 20px 0; font-size: 10pt; }
      th { background: var(--primary-blue); color: white; padding: 12px; text-align: left; font-weight: 600; }
      td { padding: 10px 12px; border: 1px solid var(--border-gray); }
      tr:nth-child(even) { background: var(--bg-gray); }
      code { font-family: 'Consolas', 'Monaco', monospace; font-size: 10pt; background: #f5f5f5; padding: 2px 6px; border-radius: 3px; border: 1px solid var(--border-gray); }
      pre { background: #1e1e1e; color: #d4d4d4; padding: 20px; border-radius: 8px; margin: 20px 0; font-family: 'Consolas', 'Monaco', monospace; font-size: 10pt; line-height: 1.5; overflow-x: auto; }
      pre code { background: transparent; border: none; color: inherit; padding: 0; }
      ul, ol { margin: 15px 0 15px 30px; }
      li { margin: 8px 0; }
      .section-number { color: var(--primary-blue); font-weight: 600; }
      .toc-item { margin: 8px 0; display: flex; justify-content: space-between; border-bottom: 1px dotted #ccc; padding-bottom: 4px; }
      .toc-level-1 { font-weight: 600; margin-top: 15px; }
      .toc-level-2 { margin-left: 20px; }
      .toc-level-3 { margin-left: 40px; font-size: 10pt; }
      .diagram { border: 2px solid var(--border-gray); border-radius: 8px; padding: 30px; margin: 25px 0; background: white; text-align: center; }
      .diagram-box { border: 2px solid var(--primary-blue); border-radius: 6px; padding: 15px; margin: 10px; text-align: center; background: #e3f2fd; font-weight: 500; display: inline-block; min-width: 120px; }
      .arrow { text-align: center; font-size: 20pt; color: var(--primary-blue); margin: 10px 0; }
      .section-break { margin: 50px 0; border-top: 2px solid var(--border-gray); padding-top: 30px; }
      .page-footer { margin-top: 50px; padding-top: 20px; border-top: 1px solid #ddd; text-align: center; font-size: 9pt; color: #999; }
      .page-footer a { color: #004578; text-decoration: none; font-weight: 600; }
      input:not([type='checkbox']):not([type='radio']) { display: none; }
      @media (max-width: 700px) {
        body { padding: 0 20px 20px 20px; }
        .back-bar { margin: 0 -20px 20px -20px; }
      }
    </style>
</head>
<body>

  <!-- BACK TO HOME BAR -->
  <div class="back-bar">
    <a href="https://stephen-ade.github.io">&#8592; Back to Home</a>
    <div class="breadcrumb">
      <span>stephen-ade.github.io</span> / Azure / EntraID / DynamicCAPS
    </div>
  </div>

  <div class="title-page">
    <h1>Dynamic Conditional Access Policies<br>with Custom Security Attributes</h1>
    <div class="subtitle">Enterprise Architecture Guide</div>
    <div class="subtitle">A Comprehensive Framework for Identity and Access Management</div>
    <div class="metadata">
      <p><strong>Version:</strong> 1.0 &nbsp;|&nbsp; <strong>Date:</strong> October 2025</p>
      <p><strong>Prepared For:</strong> CISOs, Security Architects, System Engineers, and Identity Architects</p>
    </div>
  </div>

  <div class="author-line">
    By <a href="https://stephen-ade.github.io">Stephen A. Adebowale</a> &mdash; Senior Information Security Architect/vCISO &nbsp;|&nbsp;
    <a href="https://www.linkedin.com/in/stephen-ade-0ba27110" target="_blank">LinkedIn</a> &nbsp;|&nbsp;
    <a href="https://x.com/SteveInfosec" target="_blank">X @SteveInfosec</a>
  </div>


  <h2>Executive Summary</h2>
  <p>In today's rapidly evolving digital landscape, enterprises face an unprecedented challenge: securing access to hundreds or thousands of cloud applications while maintaining agility and operational efficiency. Traditional Conditional Access Policies (CAPs), while powerful, create significant management overhead through policy proliferation—often requiring one policy per application to address unique security requirements. This approach is neither scalable nor sustainable for modern enterprises.</p>
  <p><strong>Dynamic Conditional Access Policies with Custom Security Attributes</strong> represent a paradigm shift in identity and access management. By leveraging Custom Security Attributes as intelligent metadata tags, enterprises can reduce policy count by 70-80% while simultaneously increasing flexibility and control. Instead of creating individual policies for each application, security teams define reusable attributes that applications "inherit," enabling sophisticated, application-specific security controls through a fraction of the policies.</p>

  <h3>Key Benefits</h3>
  <ul>
    <li><strong>Dramatic Policy Reduction:</strong> Manage 500 applications with 10-15 policies instead of 500+ individual policies</li>
    <li><strong>Enhanced Scalability:</strong> Onboard new applications in minutes by assigning attributes, not creating policies</li>
    <li><strong>Delegated Governance:</strong> Empower application owners to manage security requirements within guardrails</li>
    <li><strong>Operational Agility:</strong> Rapidly respond to changing security requirements without policy sprawl</li>
    <li><strong>Reduced Risk:</strong> Fewer policies mean fewer configuration errors and simplified testing</li>
    <li><strong>Cost Efficiency:</strong> Reduce administrative overhead by 60-70% through simplified management</li>
    <li><strong>Improved Compliance:</strong> Centralized attribute taxonomy ensures consistent application of security controls</li>
    <li><strong>Better User Experience:</strong> Targeted security controls based on application risk, not blanket restrictions</li>
  </ul>

  <h3>Strategic Importance</h3>
  <p>Dynamic CAPs align with three critical enterprise imperatives:</p>
  <ol>
    <li><strong>Zero Trust Architecture:</strong> Enable granular, context-aware access controls that verify explicitly and use least privilege access</li>
    <li><strong>Cloud Transformation:</strong> Provide the agility needed to secure cloud-first and hybrid environments at scale</li>
    <li><strong>Risk-Based Security:</strong> Apply security controls proportionate to application risk and sensitivity</li>
  </ol>

  <div class="callout callout-critical">
    <div class="callout-title">&#x1F6A8; CRITICAL REQUIREMENT</div>
    <p>Dynamic CAPs are <strong>NOT</strong> a replacement for baseline persona-based Conditional Access policies. All enterprises <strong>MUST</strong> first implement comprehensive baseline policies covering ALL RESOURCES for all user personas (all users, guests, administrators, etc.). Dynamic CAPs enhance baseline policies by adding application-specific requirements on top of this foundation. Attempting to use Dynamic CAPs without baseline policies creates significant security gaps.</p>
  </div>

  <div class="section-break">
    <h2>Table of Contents</h2>
    <div class="toc-item toc-level-1"><span>1. Introduction to Dynamic Conditional Access Policies</span></div>
    <div class="toc-item toc-level-2"><span>1.1 Executive Overview</span></div>
    <div class="toc-item toc-level-2"><span>1.2 What is a Dynamic Conditional Access Policy?</span></div>
    <div class="toc-item toc-level-2"><span>1.3 Understanding Custom Security Attributes</span></div>
    <div class="toc-item toc-level-2"><span>1.4 The Evolution of Conditional Access</span></div>
    <div class="toc-item toc-level-2"><span>1.5 Technical Architecture Overview</span></div>
    <div class="toc-item toc-level-1"><span>2. Why Dynamic CAPs Are Used</span></div>
    <div class="toc-item toc-level-1"><span>3. How Dynamic CAPs Are Used</span></div>
    <div class="toc-item toc-level-1"><span>4. What Dynamic CAPs Are Used For</span></div>
    <div class="toc-item toc-level-1"><span>5. Where Dynamic CAPs Are Used</span></div>
    <div class="toc-item toc-level-1"><span>6. Who Uses and Maintains Dynamic CAPs</span></div>
    <div class="toc-item toc-level-1"><span>7. Design Best Practices</span></div>
    <div class="toc-item toc-level-1"><span>8. Deployment Best Practices</span></div>
    <div class="toc-item toc-level-1"><span>9. Monitoring and Logging</span></div>
    <div class="toc-item toc-level-1"><span>10. Technical Reference</span></div>
    <div class="toc-item toc-level-1"><span>11. Governance and Compliance</span></div>
    <div class="toc-item toc-level-1"><span>12. Conclusion and Recommendations</span></div>
    <div class="toc-item toc-level-1"><span>Appendices A-E</span></div>
  </div>


  <div class="section-break">
    <h2><span class="section-number">1.</span> Introduction to Dynamic Conditional Access Policies</h2>

    <h3><span class="section-number">1.1</span> Executive Overview</h3>
    <p>Modern enterprises face a critical inflection point in identity and access management. The traditional approach of creating individual Conditional Access Policies for each application has become untenable as organizations scale their cloud footprint. A typical Fortune 500 company with 1,000+ cloud applications would need to manage an equivalent number of policies, each with unique security requirements, exceptions, and maintenance overhead.</p>
    <p>The challenge of policy sprawl in modern enterprises manifests in several ways:</p>
    <ul>
      <li><strong>Administrative Complexity:</strong> Managing hundreds or thousands of individual policies requires significant resources and expertise</li>
      <li><strong>Increased Risk:</strong> More policies mean more opportunities for misconfiguration and security gaps</li>
      <li><strong>Reduced Agility:</strong> Adding new applications or changing security requirements requires creating or modifying multiple policies</li>
      <li><strong>Inconsistent Security:</strong> Similar applications may have different security controls due to policy drift over time</li>
      <li><strong>Testing Overhead:</strong> Validating hundreds of policies becomes a bottleneck for security improvements</li>
    </ul>
    <p>Dynamic Conditional Access Policies with Custom Security Attributes solve these challenges by introducing a new paradigm: instead of creating policies for applications, we create policies for security requirements and tag applications with those requirements.</p>

    <h3><span class="section-number">1.2</span> What is a Dynamic Conditional Access Policy?</h3>
    <p>A Dynamic Conditional Access Policy is a Conditional Access Policy that uses application filters based on Custom Security Attributes to dynamically determine which applications are in scope. Rather than explicitly listing applications in the policy, the policy uses intelligent filtering to automatically include or exclude applications based on their assigned security attributes.</p>

    <h4>Traditional Static CAP Approach:</h4>
    <ul>
      <li>Policy 1: "SharePoint Online - Require MFA + Compliant Device"</li>
      <li>Policy 2: "Exchange Online - Require MFA + Compliant Device"</li>
      <li>Policy 3: "Teams - Require MFA + Compliant Device"</li>
      <li>Policy 4: "Power BI - Require MFA + Compliant Device"</li>
      <li>Policy 5: "Dynamics 365 - Require MFA + Compliant Device"</li>
    </ul>
    <p><em>Result: 5 policies for 5 applications, all with identical security requirements</em></p>

    <h4>Dynamic CAP Approach:</h4>
    <ul>
      <li>Attribute: SecurityLevel = "Standard" (assigned to all 5 applications)</li>
      <li>Policy 1: "Applications with SecurityLevel=Standard - Require MFA + Compliant Device"</li>
    </ul>
    <p><em>Result: 1 policy covering 5 applications through intelligent attribute matching</em></p>

    <table>
      <thead><tr><th>Aspect</th><th>Static CAPs</th><th>Dynamic CAPs</th></tr></thead>
      <tbody>
        <tr><td>Policy Count</td><td>1 policy per application</td><td>1 policy per security requirement</td></tr>
        <tr><td>Application Targeting</td><td>Explicit application selection</td><td>Attribute-based filtering</td></tr>
        <tr><td>New Application Onboarding</td><td>Create new policy or modify existing</td><td>Assign appropriate attributes</td></tr>
        <tr><td>Maintenance Overhead</td><td>High - manage N policies</td><td>Low - manage attributes + few policies</td></tr>
        <tr><td>Consistency</td><td>Manual effort required</td><td>Automatic through attribute taxonomy</td></tr>
        <tr><td>Exception Management</td><td>Complex - requires policy modification</td><td>Simple - change attribute assignment</td></tr>
        <tr><td>Audit and Compliance</td><td>Application-specific evidence</td><td>Attribute-based compliance mapping</td></tr>
        <tr><td>Testing Requirements</td><td>Test every policy change</td><td>Test attribute assignment changes</td></tr>
      </tbody>
    </table>

    <h3><span class="section-number">1.3</span> Understanding Custom Security Attributes</h3>
    <p>Custom Security Attributes in Microsoft Entra ID provide a powerful framework for extending directory objects with business-specific metadata. Unlike traditional directory extensions, Custom Security Attributes are designed specifically for security and governance scenarios, offering enhanced access control and audit capabilities.</p>

    <h4>Key Concepts</h4>
    <p><strong>Attribute Sets:</strong> Logical containers that group related attributes together. Each attribute set can contain up to 500 attributes and can be managed independently.</p>
    <p><strong>Attribute Definitions:</strong> The schema definition of an attribute, including its name, data type, allowed values, and business description.</p>
    <p><strong>Attribute Assignments:</strong> The actual values assigned to directory objects (users or service principals).</p>

    <h4>Data Types and Use Cases</h4>
    <table>
      <thead><tr><th>Data Type</th><th>Description</th><th>Use Cases</th><th>Example Values</th></tr></thead>
      <tbody>
        <tr><td>Boolean</td><td>True/False values</td><td>Feature flags, compliance requirements</td><td>true, false</td></tr>
        <tr><td>Integer</td><td>Numeric values</td><td>Risk scores, priority levels</td><td>1, 2, 3, 100</td></tr>
        <tr><td>String</td><td>Text values (single or multiple)</td><td>Security levels, geographical regions</td><td>"Standard", "US", "Finance"</td></tr>
      </tbody>
    </table>

    <h4>Attribute Properties and Lifecycle</h4>
    <table>
      <thead><tr><th>Property</th><th>Description</th><th>Can Change Later?</th></tr></thead>
      <tbody>
        <tr><td>Attribute Set Name</td><td>Container for related attributes</td><td>No</td></tr>
        <tr><td>Attribute Name</td><td>Unique identifier within set</td><td>No</td></tr>
        <tr><td>Data Type</td><td>Boolean, Integer, or String</td><td>No</td></tr>
        <tr><td>Allow Multiple Values</td><td>Single or multi-value assignment</td><td>No</td></tr>
        <tr><td>Predefined Values Only</td><td>Restrict to specific values</td><td>Yes (No→Yes only)</td></tr>
        <tr><td>Predefined Values List</td><td>Allowed values when restricted</td><td>Yes</td></tr>
        <tr><td>Attribute Active Status</td><td>Enable/disable attribute</td><td>Yes</td></tr>
      </tbody>
    </table>

    <div class="callout callout-info">
      <div class="callout-title">&#x1F4A1; Service Principal vs Application</div>
      <p>In the context of Dynamic CAPs, we assign attributes to <strong>service principals</strong> (the instance of an application in your tenant) rather than application objects (the global definition of the application). This distinction is important for multi-tenant applications where you want tenant-specific security requirements.</p>
    </div>

    <h3><span class="section-number">1.4</span> The Evolution of Conditional Access</h3>
    <h4>The Policy Explosion Problem</h4>
    <table>
      <thead><tr><th>Year</th><th>Applications</th><th>Policies</th><th>Management Overhead</th><th>Primary Challenges</th></tr></thead>
      <tbody>
        <tr><td>2018</td><td>10</td><td>10</td><td>Low</td><td>Learning curve</td></tr>
        <tr><td>2020</td><td>50</td><td>75</td><td>Medium</td><td>Policy standardization</td></tr>
        <tr><td>2022</td><td>200</td><td>350</td><td>High</td><td>Exception management</td></tr>
        <tr><td>2024</td><td>500</td><td>800+</td><td>Critical</td><td>Scalability crisis</td></tr>
      </tbody>
    </table>

    <h4>The Shift to Dynamic, Attribute-Based Policies</h4>
    <table>
      <thead><tr><th>Traditional Model</th><th>Dynamic Model</th><th>Improvement</th></tr></thead>
      <tbody>
        <tr><td>Reactive policy creation</td><td>Proactive attribute taxonomy</td><td>Predictable governance</td></tr>
        <tr><td>Application-specific security</td><td>Risk-based security levels</td><td>Consistent protection</td></tr>
        <tr><td>Manual policy management</td><td>Automated attribute assignment</td><td>Operational efficiency</td></tr>
        <tr><td>Siloed security decisions</td><td>Centralized security taxonomy</td><td>Strategic alignment</td></tr>
        <tr><td>Point-in-time compliance</td><td>Continuous compliance monitoring</td><td>Regulatory readiness</td></tr>
      </tbody>
    </table>

    <h3><span class="section-number">1.5</span> Technical Architecture Overview</h3>
    <div class="diagram">
      <h4 style="margin-bottom:20px">Dynamic CAP Architecture</h4>
      <div style="display:flex;justify-content:space-between;margin-bottom:20px">
        <div class="diagram-box" style="width:20%">User<br>Authentication</div>
        <div class="diagram-box" style="width:20%">Microsoft<br>Entra ID</div>
        <div class="diagram-box" style="width:20%">CAP Engine</div>
        <div class="diagram-box" style="width:20%">Target<br>Application</div>
      </div>
      <div class="arrow">&#8595;</div>
      <div style="display:flex;justify-content:space-between;margin:20px 0">
        <div class="diagram-box" style="width:30%">Baseline Policies<br>(All Users/Apps)</div>
        <div class="diagram-box" style="width:30%">Dynamic Policies<br>(Attribute-based)</div>
        <div class="diagram-box" style="width:30%">Security Controls<br>Applied</div>
      </div>
      <div class="arrow">&#8595;</div>
      <div style="display:flex;justify-content:space-between">
        <div class="diagram-box" style="width:22%">Attribute<br>Query</div>
        <div class="diagram-box" style="width:22%">Filter<br>Evaluation</div>
        <div class="diagram-box" style="width:22%">Policy<br>Match</div>
        <div class="diagram-box" style="width:22%">Access<br>Decision</div>
      </div>
    </div>

    <h4>Integration Points</h4>
    <table>
      <thead><tr><th>Integration Point</th><th>Purpose</th><th>Frequency</th></tr></thead>
      <tbody>
        <tr><td>Microsoft Graph API</td><td>Attribute management and queries</td><td>Real-time</td></tr>
        <tr><td>Azure Monitor</td><td>Logging and alerting</td><td>Near real-time</td></tr>
        <tr><td>Microsoft Sentinel</td><td>Security monitoring and SIEM</td><td>Near real-time</td></tr>
        <tr><td>PowerShell/CLI</td><td>Automation and management</td><td>On-demand</td></tr>
        <tr><td>Third-party SIEM</td><td>Security monitoring</td><td>Configurable</td></tr>
      </tbody>
    </table>
  </div>


  <div class="section-break">
    <h2><span class="section-number">2.</span> Why Dynamic CAPs Are Used</h2>

    <h3><span class="section-number">2.1</span> Business Drivers</h3>
    <ul>
      <li><strong>Application Portfolio Growth:</strong> Enterprises are adding 15-20% more cloud applications annually</li>
      <li><strong>Multi-Cloud Strategies:</strong> Organizations use an average of 2.6 public clouds, each with different security models</li>
      <li><strong>Zero Trust Principles:</strong> Never trust, always verify with context-aware access controls</li>
      <li><strong>Regulatory Compliance:</strong> GDPR, HIPAA, PCI-DSS, and FedRAMP have unique access control requirements</li>
      <li><strong>DevOps Integration:</strong> Security controls must integrate seamlessly with CI/CD pipelines</li>
    </ul>

    <h3><span class="section-number">2.2</span> Challenges with Traditional CAPs</h3>
    <h4>Policy Sprawl: The Mathematical Reality</h4>
    <table>
      <thead><tr><th>Applications</th><th>Base Policies</th><th>Exception Policies</th><th>Compliance Policies</th><th>Total Policies</th><th>Mgmt Hours/Month</th></tr></thead>
      <tbody>
        <tr><td>10</td><td>10</td><td>3</td><td>2</td><td>15</td><td>5</td></tr>
        <tr><td>50</td><td>50</td><td>15</td><td>10</td><td>75</td><td>25</td></tr>
        <tr><td>200</td><td>200</td><td>60</td><td>40</td><td>300</td><td>100</td></tr>
        <tr><td>500</td><td>500</td><td>150</td><td>100</td><td>750</td><td>250</td></tr>
        <tr><td>1000</td><td>1000</td><td>300</td><td>200</td><td>1500</td><td>500+</td></tr>
      </tbody>
    </table>

    <h3><span class="section-number">2.3</span> Benefits of Dynamic CAPs</h3>
    <table>
      <thead><tr><th>Scenario</th><th>Traditional Policies</th><th>Dynamic Policies</th><th>Reduction</th><th>Time Savings</th></tr></thead>
      <tbody>
        <tr><td>Small Enterprise (50 apps)</td><td>75</td><td>12</td><td>84%</td><td>20 hours/month</td></tr>
        <tr><td>Mid Enterprise (200 apps)</td><td>300</td><td>18</td><td>94%</td><td>80 hours/month</td></tr>
        <tr><td>Large Enterprise (500 apps)</td><td>750</td><td>25</td><td>97%</td><td>200 hours/month</td></tr>
        <tr><td>Enterprise (1000 apps)</td><td>1500</td><td>35</td><td>98%</td><td>400 hours/month</td></tr>
      </tbody>
    </table>

    <h4>Application Onboarding Time Comparison</h4>
    <table>
      <thead><tr><th>Activity</th><th>Traditional Approach</th><th>Dynamic CAP Approach</th><th>Time Savings</th></tr></thead>
      <tbody>
        <tr><td>Security Assessment</td><td>2-4 hours</td><td>30 minutes</td><td>2-3.5 hours</td></tr>
        <tr><td>Policy Creation</td><td>1-2 hours</td><td>5 minutes</td><td>1-2 hours</td></tr>
        <tr><td>Testing</td><td>4-8 hours</td><td>30 minutes</td><td>3.5-7.5 hours</td></tr>
        <tr><td>Documentation</td><td>1 hour</td><td>10 minutes</td><td>50 minutes</td></tr>
        <tr><td>Approval Process</td><td>24-48 hours</td><td>2-4 hours</td><td>20-44 hours</td></tr>
        <tr><td><strong>Total</strong></td><td><strong>32-62 hours</strong></td><td><strong>3-5 hours</strong></td><td><strong>27-57 hours</strong></td></tr>
      </tbody>
    </table>

    <h3><span class="section-number">2.4</span> Enterprise Use Cases</h3>
    <table>
      <thead><tr><th>Scenario</th><th>Industry</th><th>Traditional Approach</th><th>Dynamic Approach</th><th>Benefits</th></tr></thead>
      <tbody>
        <tr><td>High-Value Financial Applications</td><td>Financial Services</td><td>25 individual policies for trading platforms</td><td>1 policy targeting SecurityLevel="Maximum"</td><td>96% policy reduction</td></tr>
        <tr><td>Healthcare Data Access</td><td>Healthcare</td><td>40 policies for EMR systems</td><td>2 policies (HIPAA + Geographic attributes)</td><td>95% reduction</td></tr>
        <tr><td>Executive Protection</td><td>All Industries</td><td>15 policies for executive apps</td><td>1 policy for ExecutiveAccess="Required"</td><td>93% reduction</td></tr>
        <tr><td>PCI-DSS Compliance</td><td>Retail</td><td>25 policies for payment applications</td><td>1 policy for PCIScope="InScope"</td><td>96% reduction</td></tr>
      </tbody>
    </table>

    <h3><span class="section-number">2.5</span> Quantifiable Impact</h3>
    <table>
      <thead><tr><th>Metric</th><th>Before Dynamic CAPs</th><th>After Dynamic CAPs</th><th>Improvement</th></tr></thead>
      <tbody>
        <tr><td>Number of Conditional Access Policies</td><td>150-500+</td><td>15-30</td><td>70-95% reduction</td></tr>
        <tr><td>Time to Onboard New Application</td><td>2-4 hours</td><td>10-15 minutes</td><td>85-90% faster</td></tr>
        <tr><td>Policy Management Effort (hours/month)</td><td>80-120 hours</td><td>20-30 hours</td><td>70-75% reduction</td></tr>
        <tr><td>Configuration Errors per Quarter</td><td>10-15</td><td>1-3</td><td>80-90% reduction</td></tr>
        <tr><td>Time to Implement Security Changes</td><td>1-2 weeks</td><td>1-2 days</td><td>80-90% faster</td></tr>
      </tbody>
    </table>
  </div>


  <div class="section-break">
    <h2><span class="section-number">3.</span> How Dynamic CAPs Are Used</h2>

    <h3><span class="section-number">3.1</span> Technical Architecture Deep Dive</h3>
    <p>When a user attempts to access an application, the following sequence occurs:</p>
    <ol>
      <li><strong>Authentication Request:</strong> User initiates sign-in to an application</li>
      <li><strong>Service Principal Identification:</strong> Entra ID identifies the target service principal</li>
      <li><strong>Attribute Retrieval:</strong> System loads all custom security attributes assigned to the service principal</li>
      <li><strong>Baseline Policy Evaluation:</strong> Persona-based baseline policies are evaluated first (ALL RESOURCES scope)</li>
      <li><strong>Dynamic Policy Matching:</strong> Application filters in dynamic CAPs are evaluated against the service principal's attributes</li>
      <li><strong>Policy Aggregation:</strong> All matching policies (baseline + dynamic) are combined</li>
      <li><strong>Control Application:</strong> The strictest required controls are applied</li>
      <li><strong>Access Decision:</strong> Access is granted or blocked based on whether all controls are satisfied</li>
      <li><strong>Session Establishment:</strong> If granted, session controls from all matching policies are applied</li>
    </ol>

    <div class="callout callout-info">
      <div class="callout-title">&#x1F4A1; Policy Evaluation Performance</div>
      <p>Attribute-based policy evaluation adds negligible latency to authentication (typically &lt;50ms). Attributes are cached and indexed for fast retrieval, and the application filter evaluation is highly optimized.</p>
    </div>

    <h3><span class="section-number">3.2</span> Custom Security Attributes as Metadata Tags</h3>
    <h4>Attribute Assignment Mechanisms</h4>
    <table>
      <thead><tr><th>Method</th><th>Use Case</th><th>Advantages</th><th>Considerations</th></tr></thead>
      <tbody>
        <tr><td>Azure Portal (Entra Admin Center)</td><td>Individual application tagging, initial setup</td><td>Visual interface, easy to learn</td><td>Manual process, not suitable for bulk operations</td></tr>
        <tr><td>Microsoft Graph API</td><td>Automated workflows, integration with CMDB</td><td>Programmatic control, integration capabilities</td><td>Requires development expertise</td></tr>
        <tr><td>PowerShell (Graph SDK)</td><td>Bulk operations, scripted management</td><td>Automation, reusable scripts, audit trails</td><td>Requires PowerShell expertise</td></tr>
        <tr><td>Azure CLI</td><td>Command-line automation, CI/CD pipelines</td><td>Cross-platform, simple syntax</td><td>Limited compared to PowerShell/Graph API</td></tr>
      </tbody>
    </table>

    <h4>Graph API Query Examples</h4>
    <pre><code>// 1. Find all apps with specific security level
GET https://graph.microsoft.com/v1.0/servicePrincipals?$filter=customSecurityAttributes/ContosoSecurity/SecurityLevel eq 'Maximum'

// 2. Find apps with multiple attribute conditions
GET https://graph.microsoft.com/v1.0/servicePrincipals?$filter=customSecurityAttributes/ContosoSecurity/SecurityLevel eq 'Enhanced' and customSecurityAttributes/ContosoCompliance/HIPAAScope eq true

// 3. Select specific attributes in response
GET https://graph.microsoft.com/v1.0/servicePrincipals?$select=displayName,customSecurityAttributes</code></pre>

    <h3><span class="section-number">3.3</span> Application Filter Mechanism</h3>
    <h4>Supported Operators</h4>
    <table>
      <thead><tr><th>Operator</th><th>Description</th><th>Example</th></tr></thead>
      <tbody>
        <tr><td>-eq</td><td>Equals (exact match)</td><td>SecurityLevel -eq "Maximum"</td></tr>
        <tr><td>-ne</td><td>Not equals</td><td>Environment -ne "Production"</td></tr>
        <tr><td>-in</td><td>Value in list</td><td>Region -in ["US", "EU", "APAC"]</td></tr>
        <tr><td>-contains</td><td>Contains substring</td><td>Department -contains "Finance"</td></tr>
        <tr><td>-startsWith</td><td>Starts with string</td><td>AppName -startsWith "Contoso"</td></tr>
      </tbody>
    </table>

    <h4>Complex Filter Examples</h4>
    <pre><code>// Single attribute match
application.extension_abc123_SecurityLevel -eq "Enhanced"

// Multiple attributes with AND logic
application.extension_abc123_SecurityLevel -eq "Maximum" -and 
application.extension_abc123_ComplianceFramework -eq "HIPAA"

// Multiple attributes with OR logic
application.extension_abc123_DataClassification -eq "PHI" -or 
application.extension_abc123_DataClassification -eq "PII"

// Combining AND/OR
(application.extension_abc123_SecurityLevel -eq "Enhanced" -or 
 application.extension_abc123_SecurityLevel -eq "Maximum") -and
application.extension_abc123_NetworkRequirement -eq "TrustedOnly"</code></pre>

    <h3><span class="section-number">3.4</span> Implementation Approach 1: Aggregated Controls</h3>
    <table>
      <thead><tr><th>Security Level</th><th>Authentication</th><th>Device</th><th>Network</th><th>Session Controls</th></tr></thead>
      <tbody>
        <tr><td><strong>Level 1: Standard</strong></td><td>MFA Required</td><td>Compliant or Hybrid Joined</td><td>Any location</td><td>Token lifetime: 12 hours</td></tr>
        <tr><td><strong>Level 2: Enhanced</strong></td><td>Passkeys or Passwordless</td><td>Compliant Device Required</td><td>Corporate network or VPN</td><td>Token lifetime: 4 hours</td></tr>
        <tr><td><strong>Level 3: Maximum</strong></td><td>Phishing-resistant MFA</td><td>Compliant Device Required</td><td>Trusted locations only</td><td>Token lifetime: 1 hour, No downloads</td></tr>
      </tbody>
    </table>

    <h4>PowerShell: Create Attribute Set and Assign to Applications</h4>
    <pre><code>Connect-MgGraph -Scopes "CustomSecAttributeDefinition.ReadWrite.All"

# Create attribute set
$attributeSet = @{
    Id = "ContosoSecurity"
    Description = "Contoso security level attributes for dynamic CAPs"
    MaxAttributesPerSet = 25
}
New-MgDirectoryAttributeSet -BodyParameter $attributeSet

# Create SecurityLevel attribute
$attribute = @{
    AttributeSet = "ContosoSecurity"
    Name = "SecurityLevel"
    Type = "String"
    UsePreDefinedValuesOnly = $true
    AllowedValues = @(
        @{ Id = "Standard"; IsActive = $true }
        @{ Id = "Enhanced"; IsActive = $true }
        @{ Id = "Maximum"; IsActive = $true }
    )
}
New-MgDirectoryCustomSecurityAttributeDefinition -BodyParameter $attribute</code></pre>

    <div class="callout callout-success">
      <div class="callout-title">&#x2705; Best Practice: Start with Aggregated, Evolve to Fine-Grained</div>
      <p>Many successful implementations start with the Aggregated Controls approach to gain experience and demonstrate value, then evolve to Fine-Grained Attributes as requirements become more sophisticated.</p>
    </div>

    <h3><span class="section-number">3.5</span> Implementation Approach 2: Fine-Grained Attributes</h3>
    <p>The Fine-Grained Attributes approach treats each security dimension as a separate attribute, allowing applications to have precisely tailored security controls.</p>

    <table>
      <thead><tr><th>Attribute Category</th><th>Attribute Name</th><th>Data Type</th><th>Possible Values</th></tr></thead>
      <tbody>
        <tr><td rowspan="2"><strong>Authentication</strong></td><td>AuthenticationStrength</td><td>String</td><td>MFA, Passwordless, PhishingResistant</td></tr>
        <tr><td>AllowSMSMFA</td><td>Boolean</td><td>true, false</td></tr>
        <tr><td rowspan="2"><strong>Device Requirements</strong></td><td>DeviceCompliance</td><td>String</td><td>Required, Preferred, NotRequired</td></tr>
        <tr><td>AllowBYOD</td><td>Boolean</td><td>true, false</td></tr>
        <tr><td rowspan="2"><strong>Network</strong></td><td>NetworkRequirement</td><td>String</td><td>Any, Corporate, TrustedOnly</td></tr>
        <tr><td>BlockHighRiskCountries</td><td>Boolean</td><td>true, false</td></tr>
        <tr><td rowspan="2"><strong>Session Controls</strong></td><td>TokenLifetime</td><td>String</td><td>1h, 4h, 8h, 12h, 24h</td></tr>
        <tr><td>SessionType</td><td>String</td><td>Standard, Restricted, Privileged</td></tr>
        <tr><td rowspan="3"><strong>Data Protection</strong></td><td>AllowDownload</td><td>Boolean</td><td>true, false</td></tr>
        <tr><td>AllowPrint</td><td>Boolean</td><td>true, false</td></tr>
        <tr><td>AllowCopyPaste</td><td>Boolean</td><td>true, false</td></tr>
      </tbody>
    </table>

    <h3><span class="section-number">3.6</span> Approach Comparison and Selection</h3>
    <table>
      <thead><tr><th>Decision Factor</th><th>Choose Aggregated</th><th>Choose Fine-Grained</th></tr></thead>
      <tbody>
        <tr><td>Team Experience</td><td>New to Dynamic CAPs</td><td>Experienced with Conditional Access</td></tr>
        <tr><td>Application Portfolio</td><td>Mostly standard business apps</td><td>Diverse with unique requirements</td></tr>
        <tr><td>Governance Model</td><td>Centralized control</td><td>Delegated to application owners</td></tr>
        <tr><td>Time to Implement</td><td>Need quick wins (2-4 weeks)</td><td>Can invest time (6-12 weeks)</td></tr>
        <tr><td>Compliance Needs</td><td>Standard frameworks</td><td>Multiple complex frameworks</td></tr>
      </tbody>
    </table>

    <h3><span class="section-number">3.7</span> Integration with Baseline Persona-Based CAPs</h3>
    <div class="callout callout-critical">
      <div class="callout-title">&#x1F6A8; MANDATORY FOUNDATION</div>
      <p>Before implementing Dynamic CAPs, you MUST have baseline persona-based Conditional Access policies that cover ALL RESOURCES for all user types. Dynamic CAPs are an enhancement layer, not a replacement.</p>
    </div>

    <div class="diagram">
      <h4 style="margin-bottom:20px">Policy Layering Architecture</h4>
      <div class="diagram-box" style="width:90%;background:#ffebee;border-color:#d13438">FOUNDATION: Baseline Policies (ALL RESOURCES)<br>All Users: MFA Required | Guests: MFA + Compliant Device | Admins: Phishing-resistant MFA + Trusted Network</div>
      <div class="arrow">&#8593; Enhances</div>
      <div class="diagram-box" style="width:90%;background:#e3f2fd;border-color:#0078d4">ENHANCEMENT: Dynamic CAPs (Specific Applications)<br>SecurityLevel=Maximum: 1hr token + No downloads | HIPAAScope=True: Session monitoring | PCIScope=True: Trusted locations only</div>
    </div>
  </div>


  <div class="section-break">
    <h2><span class="section-number">4.</span> What Dynamic CAPs Are Used For</h2>

    <h3><span class="section-number">4.1</span> Enhanced Security Requirements</h3>
    <h4>Token Lifetime Management</h4>
    <ul>
      <li><strong>Standard (12 hours):</strong> General business applications</li>
      <li><strong>Sensitive (4 hours):</strong> Applications with customer data</li>
      <li><strong>Critical (1 hour):</strong> Financial systems, privileged access</li>
    </ul>
    <h4>Authentication Strength Requirements</h4>
    <ul>
      <li><strong>MFA:</strong> Any multi-factor method (SMS, app, hardware token)</li>
      <li><strong>Passwordless:</strong> Windows Hello, FIDO2, Authenticator app</li>
      <li><strong>Phishing-Resistant:</strong> FIDO2 keys, Windows Hello for Business</li>
    </ul>

    <h3><span class="section-number">4.2</span> Real-World Scenarios</h3>

    <h4>Scenario 1: Financial Trading Platform</h4>
    <p><strong>Attribute Assignment:</strong> SecurityLevel = "Maximum", DataClassification = "Financial", ComplianceFramework = "SEC"</p>
    <p><strong>Resulting Controls:</strong> Phishing-resistant MFA, compliant corporate device, trusted network only, 1-hour token lifetime, no downloads/printing/copy-paste.</p>

    <h4>Scenario 2: Healthcare EHR System</h4>
    <p><strong>Attribute Assignment:</strong> DataClassification = "PHI", ComplianceFramework = "HIPAA", SecurityLevel = "Enhanced"</p>
    <p><strong>Resulting Controls:</strong> Passwordless authentication, compliant device, 4-hour token lifetime, session monitoring, access logging for audit.</p>

    <h4>Scenario 3: Executive Email and Calendar</h4>
    <p><strong>Attribute Assignment:</strong> UserClassification = "Executive", SecurityLevel = "Enhanced"</p>
    <p><strong>Resulting Controls:</strong> Passwordless authentication, compliant device or trusted location, 4-hour token lifetime, mobile access requires managed device.</p>

    <h4>Scenario 4: Developer Tools (GitHub, Azure DevOps)</h4>
    <p><strong>Attribute Assignment:</strong> ApplicationType = "Development", SecurityLevel = "Standard"</p>
    <p><strong>Resulting Controls:</strong> MFA required, compliant device preferred (not required), 12-hour token lifetime, access from any location.</p>

    <h3><span class="section-number">4.3</span> Compliance and Regulatory Use Cases</h3>
    <table>
      <thead><tr><th>Regulation</th><th>Requirements</th><th>Attribute Design</th><th>CAP Controls</th></tr></thead>
      <tbody>
        <tr><td><strong>PCI-DSS</strong></td><td>Protect cardholder data, restrict access</td><td>PCIScope = "InScope"</td><td>Phishing-resistant MFA, trusted network, audit logging</td></tr>
        <tr><td><strong>HIPAA</strong></td><td>Protect PHI, ensure authorized access</td><td>DataClassification = "PHI"</td><td>Strong authentication, compliant device, session monitoring</td></tr>
        <tr><td><strong>SOC 2</strong></td><td>Access controls, monitoring, logging</td><td>SOC2Critical = "true"</td><td>MFA, device compliance, comprehensive logging</td></tr>
        <tr><td><strong>GDPR</strong></td><td>Protect personal data, access controls</td><td>DataClassification = "PII"</td><td>MFA, geographic restrictions, audit trail</td></tr>
      </tbody>
    </table>
  </div>

  <div class="section-break">
    <h2><span class="section-number">5.</span> Where Dynamic CAPs Are Used</h2>

    <h3><span class="section-number">5.1</span> Microsoft Entra ID Environment</h3>
    <ul>
      <li><strong>Tenant Scope:</strong> All attributes and policies exist at tenant level</li>
      <li><strong>Licensing:</strong> Included with Entra ID P1/P2 licenses (no additional cost)</li>
      <li><strong>Multi-Tenant:</strong> Each tenant manages attributes independently</li>
    </ul>

    <h3><span class="section-number">5.2</span> Supported Objects</h3>
    <p><strong>Service Principals (Applications):</strong> Enterprise applications, multi-tenant applications, Azure AD Application Proxy applications, and custom line-of-business applications registered in your tenant.</p>

    <h3><span class="section-number">5.3</span> Cloud and Hybrid Environments</h3>
    <ul>
      <li><strong>Pure Cloud:</strong> Full support for all cloud-based applications accessed via Entra ID</li>
      <li><strong>Hybrid Identity:</strong> Applications published via Azure AD Application Proxy are supported; on-premises applications integrated with Entra ID are supported</li>
    </ul>
  </div>

  <div class="section-break">
    <h2><span class="section-number">6.</span> Who Uses and Maintains Dynamic CAPs</h2>

    <h3><span class="section-number">6.1</span> Role-Based Access Control</h3>
    <table>
      <thead><tr><th>Role</th><th>Permissions</th><th>Responsibilities</th></tr></thead>
      <tbody>
        <tr><td><strong>Attribute Definition Administrator</strong></td><td>Create/manage attribute sets and definitions</td><td>Design attribute taxonomy, create attributes, manage lifecycle</td></tr>
        <tr><td><strong>Attribute Assignment Administrator</strong></td><td>Assign attributes to objects</td><td>Tag applications, manage assignments, update values</td></tr>
        <tr><td><strong>Conditional Access Administrator</strong></td><td>Create/manage CA policies</td><td>Create policies with application filters, manage policy lifecycle</td></tr>
        <tr><td><strong>Security Administrator</strong></td><td>Read security configuration</td><td>Monitor policies, review compliance, investigate incidents</td></tr>
        <tr><td><strong>Application Owner</strong></td><td>Request attribute assignments</td><td>Identify security requirements, submit requests, validate controls</td></tr>
      </tbody>
    </table>

    <div class="callout callout-warning">
      <div class="callout-title">&#x26A0;&#xFE0F; Important: Global Administrator Limitation</div>
      <p>By default, Global Administrators do <strong>NOT</strong> have permissions to manage Custom Security Attributes. This is by design for enhanced security. They must be explicitly assigned Attribute Administrator roles.</p>
    </div>

    <h3><span class="section-number">6.2</span> Responsibilities Matrix (RACI)</h3>
    <table>
      <thead><tr><th>Activity</th><th>Security Team</th><th>App Owner</th><th>IT Ops</th><th>Compliance</th></tr></thead>
      <tbody>
        <tr><td>Define attribute taxonomy</td><td>R, A</td><td>C</td><td>I</td><td>C</td></tr>
        <tr><td>Create attribute sets/definitions</td><td>R, A</td><td>I</td><td>I</td><td>I</td></tr>
        <tr><td>Assign attributes to applications</td><td>A</td><td>R</td><td>I</td><td>I</td></tr>
        <tr><td>Create Conditional Access policies</td><td>R, A</td><td>C</td><td>I</td><td>C</td></tr>
        <tr><td>Monitor policy effectiveness</td><td>R, A</td><td>C</td><td>I</td><td>I</td></tr>
        <tr><td>Audit and compliance reporting</td><td>R</td><td>I</td><td>I</td><td>A, R</td></tr>
      </tbody>
    </table>
    <p><em>R = Responsible, A = Accountable, C = Consulted, I = Informed</em></p>
  </div>


  <div class="section-break">
    <h2><span class="section-number">7.</span> Design Best Practices</h2>

    <h3><span class="section-number">7.1</span> Architecture Principles</h3>
    <ol>
      <li><strong>Baseline First, Enhancements Second:</strong> Always implement persona-based baseline CAPs for ALL RESOURCES before adding dynamic policies.</li>
      <li><strong>Attribute Taxonomy Before Implementation:</strong> Design your complete attribute taxonomy before creating attributes. Changes later are difficult and require policy updates.</li>
      <li><strong>Start Simple, Iterate:</strong> Begin with 3-5 core attributes and expand based on real requirements.</li>
      <li><strong>Document Everything:</strong> Maintain comprehensive documentation of attributes, their meanings, and appropriate use cases.</li>
      <li><strong>Principle of Least Privilege:</strong> Apply only the security controls necessary for each application's risk profile.</li>
      <li><strong>Consistent Naming Conventions:</strong> Use clear, standardized naming. Example: CompanyName_Category_AttributeName</li>
      <li><strong>Test Before Production:</strong> Always use report-only mode first. Analyze impact before enforcing policies.</li>
      <li><strong>Monitor and Measure:</strong> Establish KPIs to track policy effectiveness, user impact, and security posture.</li>
    </ol>

    <h3><span class="section-number">7.2</span> Required Baseline Policies</h3>
    <div class="callout callout-critical">
      <div class="callout-title">&#x1F6A8; NON-NEGOTIABLE REQUIREMENT</div>
      <p>You MUST implement comprehensive baseline persona-based Conditional Access policies covering ALL RESOURCES for all user types BEFORE implementing Dynamic CAPs.</p>
    </div>
    <table>
      <thead><tr><th>Policy Name</th><th>Users</th><th>Applications</th><th>Controls</th></tr></thead>
      <tbody>
        <tr><td>BASE-01: All Users MFA</td><td>All Users</td><td>All cloud apps</td><td>Require MFA</td></tr>
        <tr><td>BASE-02: All Users Device</td><td>All Users</td><td>All cloud apps</td><td>Compliant OR Hybrid Joined device</td></tr>
        <tr><td>BASE-03: Guests Enhanced</td><td>All Guests</td><td>All cloud apps</td><td>MFA AND Compliant device</td></tr>
        <tr><td>BASE-04: Admins Maximum</td><td>Directory role members</td><td>All cloud apps</td><td>Phishing-resistant MFA AND Compliant device AND Trusted locations</td></tr>
        <tr><td>BASE-05: Block Legacy Auth</td><td>All Users</td><td>All cloud apps</td><td>Block access (legacy authentication clients)</td></tr>
      </tbody>
    </table>

    <h3><span class="section-number">7.3</span> Example Attribute Taxonomy</h3>
    <p><strong>Attribute Set: CompanyName_SecurityLevels</strong> — SecurityLevel: Standard, Enhanced, Maximum</p>
    <p><strong>Attribute Set: CompanyName_Compliance</strong> — DataClassification: Public, Internal, Confidential, PHI, PCI | ComplianceFramework (multi): HIPAA, PCI-DSS, SOC2, GDPR</p>
    <p><strong>Attribute Set: CompanyName_AccessControls</strong> — NetworkRequirement: Any, Corporate, TrustedOnly | TokenLifetime: 1h, 4h, 8h, 12h</p>

    <h4>Naming Conventions</h4>
    <table>
      <thead><tr><th>Element</th><th>Format</th><th>Example</th></tr></thead>
      <tbody>
        <tr><td>Attribute Set</td><td>CompanyName_Category</td><td>Contoso_Security, Contoso_Compliance</td></tr>
        <tr><td>Attribute Name</td><td>PascalCase, no spaces</td><td>SecurityLevel, DataClassification</td></tr>
        <tr><td>Policy Name</td><td>PREFIX-##: Description</td><td>DYN-CAP-01: Enhanced Security Level</td></tr>
      </tbody>
    </table>
  </div>

  <div class="section-break">
    <h2><span class="section-number">8.</span> Deployment Best Practices</h2>

    <h3><span class="section-number">8.1</span> Pre-Deployment Checklist</h3>
    <table>
      <thead><tr><th>Requirement</th><th>Status Check</th><th>Owner</th></tr></thead>
      <tbody>
        <tr><td>Entra ID P1/P2 licenses assigned</td><td>Verify in license management</td><td>IT Operations</td></tr>
        <tr><td>Baseline CAPs implemented and tested</td><td>Review existing policies covering ALL RESOURCES</td><td>Security Team</td></tr>
        <tr><td>Break-glass accounts configured and documented</td><td>Test emergency access</td><td>Security Team</td></tr>
        <tr><td>Administrator roles assigned</td><td>Confirm Attribute Administrator roles</td><td>Identity Team</td></tr>
        <tr><td>Attribute taxonomy designed and approved</td><td>Documented and reviewed by stakeholders</td><td>Security Architecture</td></tr>
        <tr><td>Monitoring and logging infrastructure ready</td><td>Log Analytics workspace configured</td><td>IT Operations</td></tr>
      </tbody>
    </table>

    <h3><span class="section-number">8.2</span> Step-by-Step Deployment</h3>
    <h4>Phase 1: Setup (Week 1) — Create Attribute Sets and Definitions</h4>
    <pre><code>Connect-MgGraph -Scopes "CustomSecAttributeDefinition.ReadWrite.All"

$attributeSets = @(
    @{ Id = "ContosoSecurity"; Description = "Security level attributes" }
    @{ Id = "ContosoCompliance"; Description = "Compliance and regulatory attributes" }
)
foreach ($set in $attributeSets) {
    New-MgDirectoryAttributeSet -Id $set.Id -Description $set.Description -MaxAttributesPerSet 25
}

# Create SecurityLevel attribute
$params = @{
    AttributeSet = "ContosoSecurity"
    Name = "SecurityLevel"
    Type = "String"
    Status = "Available"
    UsePreDefinedValuesOnly = $true
    AllowedValues = @(
        @{ Id = "Standard"; IsActive = $true }
        @{ Id = "Enhanced"; IsActive = $true }
        @{ Id = "Maximum"; IsActive = $true }
    )
}
New-MgDirectoryCustomSecurityAttributeDefinition -BodyParameter $params</code></pre>

    <h4>Phase 2: Policy Creation in Report-Only Mode (Week 2)</h4>
    <pre><code># Create dynamic CAP — always start in report-only!
$policyParams = @{
    DisplayName = "DYN-CAP-01: Enhanced Security Level"
    State = "enabledForReportingButNotEnforced"
    Conditions = @{
        Applications = @{
            ApplicationFilter = @{
                Mode = "include"
                Rule = "application.extension_ContosoSecurity_SecurityLevel -eq 'Enhanced'"
            }
        }
        Users = @{
            IncludeUsers = @("All")
            ExcludeUsers = @("break-glass-account-id")  # Always exclude break-glass!
        }
    }
}
New-MgIdentityConditionalAccessPolicy -BodyParameter $policyParams</code></pre>

    <h4>Phase 3: Assign Attributes to Pilot Applications (Weeks 3-4)</h4>
    <pre><code>$appId = "your-application-app-id"
$servicePrincipal = Get-MgServicePrincipal -Filter "appId eq '$appId'"

$attributes = @{
    "ContosoSecurity" = @{
        "@odata.type" = "#Microsoft.DirectoryServices.CustomSecurityAttributeValue"
        "SecurityLevel" = "Enhanced"
    }
}
Update-MgServicePrincipal -ServicePrincipalId $servicePrincipal.Id -CustomSecurityAttributes $attributes</code></pre>

    <h3><span class="section-number">8.3</span> Break-Glass Account Protection</h3>
    <div class="callout callout-critical">
      <div class="callout-title">&#x1F6A8; CRITICAL: Always Exclude Break-Glass Accounts</div>
      <p>Every Conditional Access policy (baseline and dynamic) must exclude break-glass emergency access accounts. Test these accounts regularly to ensure they work.</p>
    </div>
    <ul>
      <li>At least 2 dedicated accounts (e.g., BreakGlass01, BreakGlass02)</li>
      <li>Cloud-only accounts (not synchronized)</li>
      <li>Strong, unique passwords stored in secure physical location</li>
      <li>Excluded from ALL Conditional Access policies</li>
      <li>Monitored with alerts for any usage</li>
      <li>Tested quarterly to ensure access works</li>
    </ul>

    <h3><span class="section-number">8.4</span> Testing Checklist</h3>
    <table>
      <thead><tr><th>Test Scenario</th><th>Expected Result</th><th>Status</th></tr></thead>
      <tbody>
        <tr><td>User accesses app with SecurityLevel=Enhanced</td><td>Passwordless MFA required</td><td>&#9744;</td></tr>
        <tr><td>User accesses app without attributes</td><td>Only baseline policies apply</td><td>&#9744;</td></tr>
        <tr><td>Admin accesses any app</td><td>Admin baseline + dynamic policies apply</td><td>&#9744;</td></tr>
        <tr><td>Break-glass account</td><td>Excluded from all dynamic policies</td><td>&#9744;</td></tr>
        <tr><td>Mobile device access</td><td>Appropriate controls based on attributes</td><td>&#9744;</td></tr>
      </tbody>
    </table>
  </div>


  <div class="section-break">
    <h2><span class="section-number">9.</span> Monitoring and Logging</h2>

    <h3><span class="section-number">9.1</span> Essential KQL Queries</h3>

    <h4>Query 1: Failed Sign-Ins Due to Conditional Access</h4>
    <pre><code>SigninLogs
| where TimeGenerated > ago(24h)
| where ConditionalAccessStatus == "failure"
| summarize Count=count() by AppDisplayName, ConditionalAccessPolicies
| order by Count desc</code></pre>

    <h4>Query 2: Applications Matched by Dynamic CAPs</h4>
    <pre><code>SigninLogs
| where TimeGenerated > ago(7d)
| extend DynamicPolicy = parse_json(ConditionalAccessPolicies)
| where DynamicPolicy contains "DYN-CAP"
| summarize UniqueApps=dcount(AppDisplayName) by tostring(DynamicPolicy)</code></pre>

    <h4>Query 3: Attribute Assignment Changes</h4>
    <pre><code>AuditLogs
| where TimeGenerated > ago(7d)
| where OperationName contains "Update service principal"
| where TargetResources contains "customSecurityAttributes"
| project TimeGenerated, Identity, AppDisplayName=TargetResources[0].displayName, Result</code></pre>

    <h3><span class="section-number">9.2</span> Key Performance Indicators</h3>
    <table>
      <thead><tr><th>KPI</th><th>Target</th><th>How to Measure</th></tr></thead>
      <tbody>
        <tr><td>Attribute Coverage</td><td>&gt;80% of apps have attributes assigned</td><td>Count apps with attributes / total apps</td></tr>
        <tr><td>Policy Count Reduction</td><td>70-80% fewer policies</td><td>Compare policy count before/after</td></tr>
        <tr><td>Failed Sign-Ins Rate</td><td>&lt;2% of total sign-ins</td><td>Monitor blocked sign-ins in logs</td></tr>
        <tr><td>Time to Onboard New App</td><td>&lt;30 minutes</td><td>Track from request to attribute assignment</td></tr>
      </tbody>
    </table>

    <h3><span class="section-number">9.3</span> Critical Alerts</h3>
    <table>
      <thead><tr><th>Alert Name</th><th>Condition</th><th>Action</th></tr></thead>
      <tbody>
        <tr><td>Break-glass account used</td><td>Any sign-in from break-glass accounts</td><td>Immediate notification to security team</td></tr>
        <tr><td>High CA failure rate</td><td>&gt;100 failures in 15 minutes</td><td>Page on-call engineer</td></tr>
        <tr><td>Unauthorized attribute change</td><td>Attribute modified by non-approved user</td><td>Alert security team, audit immediately</td></tr>
        <tr><td>Policy modification</td><td>Any CAP policy created/modified/deleted</td><td>Notification to security team</td></tr>
      </tbody>
    </table>
  </div>

  <div class="section-break">
    <h2><span class="section-number">10.</span> Technical Reference</h2>

    <h3><span class="section-number">10.1</span> Attribute Limits and Constraints</h3>
    <table>
      <thead><tr><th>Resource</th><th>Limit</th><th>Notes</th></tr></thead>
      <tbody>
        <tr><td>Attribute definitions per tenant</td><td>500 (active)</td><td>Deactivated attributes don't count toward limit</td></tr>
        <tr><td>Attribute sets per tenant</td><td>500</td><td>Hard limit</td></tr>
        <tr><td>Attribute name length</td><td>32 characters</td><td>Unicode, case-sensitive</td></tr>
        <tr><td>Attribute value length</td><td>64 characters</td><td>Unicode</td></tr>
        <tr><td>Predefined values per attribute</td><td>100</td><td>More values = more complex management</td></tr>
        <tr><td>Attribute values per object</td><td>50</td><td>Total across all attributes on single object</td></tr>
      </tbody>
    </table>

    <h3><span class="section-number">10.2</span> Microsoft Graph API Quick Reference</h3>
    <table>
      <thead><tr><th>Operation</th><th>HTTP Method</th><th>Endpoint</th></tr></thead>
      <tbody>
        <tr><td>List attribute sets</td><td>GET</td><td>/directory/attributeSets</td></tr>
        <tr><td>Create attribute set</td><td>POST</td><td>/directory/attributeSets</td></tr>
        <tr><td>List attribute definitions</td><td>GET</td><td>/directory/customSecurityAttributeDefinitions</td></tr>
        <tr><td>Create attribute definition</td><td>POST</td><td>/directory/customSecurityAttributeDefinitions</td></tr>
        <tr><td>Assign attribute to app</td><td>PATCH</td><td>/servicePrincipals/{id}</td></tr>
        <tr><td>Get app with attributes</td><td>GET</td><td>/servicePrincipals/{id}?$select=customSecurityAttributes</td></tr>
        <tr><td>Query apps by attribute</td><td>GET</td><td>/servicePrincipals?$filter=customSecurityAttributes/Set/Attribute eq 'Value'</td></tr>
      </tbody>
    </table>

    <h3><span class="section-number">10.3</span> Troubleshooting Guide</h3>
    <table>
      <thead><tr><th>Issue</th><th>Possible Cause</th><th>Resolution</th></tr></thead>
      <tbody>
        <tr><td>Attribute not visible in policy filter</td><td>Attribute status is inactive</td><td>Activate attribute definition</td></tr>
        <tr><td>Policy not matching expected apps</td><td>Filter syntax error</td><td>Verify attribute set ID and syntax in filter</td></tr>
        <tr><td>User blocked unexpectedly</td><td>Multiple policies combining controls</td><td>Review all policies affecting user/app combination</td></tr>
        <tr><td>Cannot assign attribute</td><td>Missing Attribute Assignment Admin role</td><td>Verify role assignment at tenant or attribute set scope</td></tr>
        <tr><td>Break-glass account blocked</td><td>Not excluded from policies</td><td>Add to exclusions in ALL policies immediately</td></tr>
      </tbody>
    </table>

    <h3><span class="section-number">10.4</span> PowerShell Script: Bulk Attribute Assignment from CSV</h3>
    <pre><code># CSV format: AppId,SecurityLevel,DataClassification
Connect-MgGraph -Scopes "Application.ReadWrite.All", "CustomSecAttributeAssignment.ReadWrite.All"

$apps = Import-Csv "applications.csv"
foreach ($app in $apps) {
    $sp = Get-MgServicePrincipal -Filter "appId eq '$($app.AppId)'"
    if ($sp) {
        $attributes = @{
            "ContosoSecurity" = @{ "SecurityLevel" = $app.SecurityLevel }
            "ContosoCompliance" = @{ "DataClassification" = $app.DataClassification }
        }
        Update-MgServicePrincipal -ServicePrincipalId $sp.Id -CustomSecurityAttributes $attributes
        Write-Host "Updated: $($sp.DisplayName)"
    } else {
        Write-Warning "App not found: $($app.AppId)"
    }
}</code></pre>
  </div>


  <div class="section-break">
    <h2><span class="section-number">11.</span> Governance and Compliance</h2>

    <h3><span class="section-number">11.1</span> Compliance Framework Mapping</h3>
    <table>
      <thead><tr><th>Framework</th><th>Relevant Controls</th><th>How Dynamic CAPs Help</th></tr></thead>
      <tbody>
        <tr><td><strong>NIST CSF</strong></td><td>PR.AC-1: Identity management; PR.AC-4: Access permissions managed</td><td>Granular access controls based on app risk; clear attribute-based authorization</td></tr>
        <tr><td><strong>ISO 27001</strong></td><td>A.9.2.1: User registration; A.9.4.1: Information access restriction</td><td>Consistent access control framework; risk-based access restrictions</td></tr>
        <tr><td><strong>SOC 2</strong></td><td>CC6.1: Logical access controls; CC6.6: Managed system activities</td><td>Documented attribute taxonomy; comprehensive audit logs</td></tr>
        <tr><td><strong>PCI-DSS</strong></td><td>Req 7: Restrict access by business need; Req 8: Strong authentication</td><td>PCIScope attribute for cardholder data apps; enhanced authentication for in-scope apps</td></tr>
        <tr><td><strong>HIPAA</strong></td><td>§164.312(a)(1): Access control; §164.312(d): Authentication</td><td>PHI classification attribute; enhanced controls for PHI applications</td></tr>
      </tbody>
    </table>

    <h3><span class="section-number">11.2</span> Access Reviews Schedule</h3>
    <table>
      <thead><tr><th>Review Type</th><th>Scope</th><th>Owner</th><th>Frequency</th></tr></thead>
      <tbody>
        <tr><td>Administrator Role Review</td><td>All Attribute Administrator role assignments</td><td>Identity Team</td><td>Quarterly</td></tr>
        <tr><td>High-Risk App Attributes</td><td>Apps with SecurityLevel=Maximum</td><td>Security Team</td><td>Quarterly</td></tr>
        <tr><td>Policy Effectiveness Review</td><td>All dynamic CAPs</td><td>Security Architecture</td><td>Quarterly</td></tr>
        <tr><td>Attribute Taxonomy Review</td><td>Is taxonomy still meeting needs?</td><td>Governance Committee</td><td>Quarterly</td></tr>
      </tbody>
    </table>
  </div>

  <div class="section-break">
    <h2><span class="section-number">12.</span> Conclusion and Recommendations</h2>

    <h3><span class="section-number">12.1</span> Implementation Roadmap</h3>
    <table>
      <thead><tr><th>Phase</th><th>Timeline</th><th>Key Activities</th><th>Success Criteria</th></tr></thead>
      <tbody>
        <tr><td><strong>Phase 0: Foundation</strong></td><td>Months 0-3</td><td>Implement baseline persona CAPs; configure break-glass accounts; design attribute taxonomy</td><td>Baseline policies protecting all resources; documented taxonomy approved</td></tr>
        <tr><td><strong>Phase 1: Pilot</strong></td><td>Months 3-6</td><td>Create attribute sets; create 3-5 dynamic CAPs in report-only; assign attributes to 10-20 pilot apps</td><td>Pilot apps successfully tagged; policies working as expected; no unexpected user impact</td></tr>
        <tr><td><strong>Phase 2: Production</strong></td><td>Months 6-12</td><td>Enable policies; expand to 100-200 applications; train application owners</td><td>50% of apps with attributes; &lt;2% failed sign-in rate</td></tr>
        <tr><td><strong>Phase 3: Maturity</strong></td><td>Months 12+</td><td>Complete portfolio coverage; optimize; implement automation</td><td>&gt;80% app coverage; 70-80% policy reduction achieved; new app onboarding &lt;30 min</td></tr>
      </tbody>
    </table>

    <h3><span class="section-number">12.2</span> Critical Success Factors</h3>
    <ol>
      <li><strong>Executive Sponsorship:</strong> Secure leadership support for the initiative</li>
      <li><strong>Baseline First:</strong> Non-negotiable — implement comprehensive baseline CAPs before dynamic policies</li>
      <li><strong>Start Simple:</strong> Begin with 3-5 core attributes, expand based on real needs</li>
      <li><strong>Clear Taxonomy:</strong> Invest time in designing a clear, logical attribute structure</li>
      <li><strong>Report-Only Testing:</strong> Always test in report-only mode for at least 1-2 weeks</li>
      <li><strong>Strong Governance:</strong> Establish clear ownership, processes, and approval workflows</li>
      <li><strong>Comprehensive Documentation:</strong> Document everything — taxonomy, policies, decisions, procedures</li>
      <li><strong>Monitor Continuously:</strong> Establish KPIs and dashboards, review regularly</li>
    </ol>

    <div class="callout callout-success">
      <div class="callout-title">&#x2705; You're Ready to Begin</div>
      <p>You now have a comprehensive framework for implementing Dynamic Conditional Access Policies with Custom Security Attributes. Start with baseline policies, design a simple taxonomy, pilot with a few applications, and expand based on learnings. The journey from hundreds of policies to a manageable, scalable identity governance framework begins with a single step.</p>
    </div>
  </div>

  <div class="section-break">
    <h2>Appendix A: Glossary of Key Terms</h2>
    <table>
      <thead><tr><th>Term</th><th>Definition</th></tr></thead>
      <tbody>
        <tr><td><strong>Application Filter</strong></td><td>A feature in Conditional Access policies that uses expressions to dynamically select applications based on Custom Security Attributes</td></tr>
        <tr><td><strong>Attribute Set</strong></td><td>A logical container that groups related custom security attributes for organization and delegation</td></tr>
        <tr><td><strong>Baseline Policy</strong></td><td>A Conditional Access policy that applies to ALL RESOURCES for a specific user persona</td></tr>
        <tr><td><strong>Break-Glass Account</strong></td><td>Emergency access accounts that bypass all Conditional Access policies</td></tr>
        <tr><td><strong>Custom Security Attribute</strong></td><td>Business-specific metadata (key-value pairs) that can be assigned to users and applications in Microsoft Entra ID</td></tr>
        <tr><td><strong>Dynamic CAP</strong></td><td>A Conditional Access policy that uses application filters to dynamically target applications based on their Custom Security Attributes</td></tr>
        <tr><td><strong>Phishing-Resistant Authentication</strong></td><td>Authentication methods resistant to phishing attacks (FIDO2 security keys, Windows Hello for Business)</td></tr>
        <tr><td><strong>Policy Sprawl</strong></td><td>The problem of managing too many Conditional Access policies, typically one per application</td></tr>
        <tr><td><strong>Report-Only Mode</strong></td><td>A CAP state where policies are evaluated but not enforced, allowing impact analysis without affecting users</td></tr>
        <tr><td><strong>Service Principal</strong></td><td>The instance of an application in your Entra ID tenant; the object to which Custom Security Attributes are assigned</td></tr>
      </tbody>
    </table>
  </div>

  <div class="section-break">
    <h2>Appendix B: Reference Links</h2>
    <h3>Microsoft Official Documentation</h3>
    <ul>
      <li>Custom Security Attributes Overview: <a href="https://learn.microsoft.com/en-us/entra/fundamentals/custom-security-attributes-overview" target="_blank">learn.microsoft.com</a></li>
      <li>Conditional Access Overview: <a href="https://learn.microsoft.com/en-us/entra/identity/conditional-access/overview" target="_blank">learn.microsoft.com</a></li>
      <li>Application Filters in CA: <a href="https://learn.microsoft.com/en-us/entra/identity/conditional-access/concept-filter-for-applications" target="_blank">learn.microsoft.com</a></li>
      <li>Microsoft Graph API - Custom Security Attributes: <a href="https://learn.microsoft.com/en-us/graph/api/resources/custom-security-attributes-overview" target="_blank">learn.microsoft.com</a></li>
    </ul>
    <h3>Tools and Utilities</h3>
    <ul>
      <li>Microsoft Graph Explorer: <a href="https://developer.microsoft.com/en-us/graph/graph-explorer" target="_blank">developer.microsoft.com</a></li>
      <li>Microsoft Graph PowerShell SDK: <a href="https://learn.microsoft.com/en-us/powershell/microsoftgraph/" target="_blank">learn.microsoft.com</a></li>
    </ul>
  </div>

  <div class="section-break">
    <h2>Appendix C: Pre/Post Deployment Checklists</h2>
    <h3>Pre-Implementation</h3>
    <table>
      <thead><tr><th>Task</th><th>Complete</th></tr></thead>
      <tbody>
        <tr><td>Baseline persona-based CAPs implemented for ALL RESOURCES</td><td>&#9744;</td></tr>
        <tr><td>Break-glass accounts configured and tested</td><td>&#9744;</td></tr>
        <tr><td>Entra ID P1/P2 licenses verified</td><td>&#9744;</td></tr>
        <tr><td>Attribute Administrator roles assigned</td><td>&#9744;</td></tr>
        <tr><td>Attribute taxonomy designed and documented</td><td>&#9744;</td></tr>
        <tr><td>Stakeholders identified and engaged</td><td>&#9744;</td></tr>
        <tr><td>Log Analytics workspace configured</td><td>&#9744;</td></tr>
      </tbody>
    </table>
    <h3>Post-Deployment</h3>
    <table>
      <thead><tr><th>Task</th><th>Complete</th></tr></thead>
      <tbody>
        <tr><td>Monitoring dashboards created</td><td>&#9744;</td></tr>
        <tr><td>Alert rules configured</td><td>&#9744;</td></tr>
        <tr><td>KPIs established and tracking</td><td>&#9744;</td></tr>
        <tr><td>Application owners trained</td><td>&#9744;</td></tr>
        <tr><td>Governance committee established</td><td>&#9744;</td></tr>
        <tr><td>Quarterly review schedule established</td><td>&#9744;</td></tr>
      </tbody>
    </table>
  </div>

  <!-- FOOTER -->
  <div class="page-footer">
    <p>Published by <a href="https://stephen-ade.github.io">Stephen A. Adebowale</a> &mdash; Senior Information Security Architect/vCISO &nbsp;|&nbsp;
    <a href="https://www.linkedin.com/in/stephen-ade-0ba27110" target="_blank">LinkedIn</a> &nbsp;|&nbsp;
    <a href="https://x.com/SteveInfosec" target="_blank">X @SteveInfosec</a></p>
    <p>&copy; 2025 Stephen A. Adebowale. All rights reserved. &nbsp;|&nbsp; Version 1.0 &nbsp;|&nbsp; October 2025</p>
  </div>

</body>
</html>
